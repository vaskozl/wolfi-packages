# yaml-language-server: $schema=https://raw.githubusercontent.com/chainguard-dev/melange/refs/heads/main/pkg/config/schema.json
# Generated from https://raw.githubusercontent.com/alpinelinux/aports/refs/heads/master/testing/lidarr/APKBUILD
package:
  name: lidarr
  version: 2.14.5.4836
  epoch: 0
  description: Music download automation for usenet and torrents.
  copyright:
    - license: GPL-3.0-only
  dependencies:
    runtime:
      - aspnet-${{vars.dotnet_version}}-runtime
      - sqlite-libs
vars:
  dotnet_version: "6"
  output: '_output'
environment:
  contents:
    packages:
      - build-base
      - busybox
      - ca-certificates-bundle
      - yarn
      - nodejs
      - aspnet-${{vars.dotnet_version}}-runtime
      - dotnet-${{vars.dotnet_version}}-sdk
      - sqlite-libs
pipeline:
  - uses: git-checkout
    with:
      repository: https://github.com/Lidarr/Lidarr
      tag: v${{package.version}}
  - pipeline:
      - runs: |
          export BROWSERSLIST_IGNORE_OLD_DATA=true
          yarn install --frozen-lockfile --network-timeout 120000
      - runs: |
          # increase max opened files
          ulimit -n 4096

          # map arch to dotnet
          case "${{build.arch}}" in
              x86_64) _dotnet_arch="x64" ;;
              aarch64) _dotnet_arch="arm64" ;;
              armv7) _dotnet_arch="arm" ;;
              *) _dotnet_arch="$CARCH" ;;
          esac

          _framework="net${{vars.dotnet_version}}.0"
          _artifacts="${{vars.output}}/$_framework/linux-$_dotnet_arch/publish"

          dotnet publish src \
          -p:AssemblyConfiguration="master" \
          -p:AssemblyVersion="${{package.version}}" \
          --framework "$_framework" \
          --no-self-contained \
          --runtime linux-$_dotnet_arch \
          --configuration Release

          yarn build --env production --no-stats

          chmod +x "$_artifacts"/fpcalc

          # cleanup
          find "$_artifacts" \( \
              -name "ServiceUninstall.*" -o \
              -name "ServiceInstall.*" -o \
              -name "Lidarr.Windows.*" \) -delete

          mv "${{vars.output}}"/UI "$_artifacts"
          mv "$_artifacts" bin
  - runs: |
      install -Dm644 package_info "${{targets.destdir}}"/usr/lib/lidarr/package_info
      echo "PackageVersion=${{package.version}}-r${{package.epoch}}" >>"${{targets.destdir}}"/usr/lib/lidarr/package_info

      cp -af bin "${{targets.destdir}}"/usr/lib/lidarr/bin
  - uses: strip
test:
  pipeline:
    - name: Verify lidarr installation, please improve the test as needed
      runs: lidarr --version || exit 1
